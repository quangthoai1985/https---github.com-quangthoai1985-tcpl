rules_version = '2';
service cloud.firestore {
match /databases/{database}/documents {

// Users can only read their own profile, Admins can read all.
match /users/{userId} {
  allow read: if request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
  allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}
// Logged-in users (both admin and staff) can read configuration data.
match /criteria/{docId} {
  allow read: if request.auth != null;
  allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}
match /units/{docId} {
  allow read: if request.auth != null;
  allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}
 match /assessmentPeriods/{docId} {
  allow read: if request.auth != null;
  allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}
match /guidanceDocuments/{docId} {
  allow read: if request.auth != null;
  allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}
// Public can read login page config
match /configurations/loginPage {
allow read: if true;
allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

// Rules for assessments
match /assessments/{assessmentId} {
  // Admins can read all, staff can read their own commune's assessments
  allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || resource.data.communeId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.communeId;
  // Staff can create/update their own, Admins can update any
  allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || request.resource.data.communeId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.communeId;
}

// Allow read access on signature_checks for admins
match /signature_checks/{checkId} {
  allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
  allow write: if false; // Should only be written by Cloud Functions
}
}
}