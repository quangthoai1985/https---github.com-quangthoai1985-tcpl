rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Allow any authenticated user to write to the 'debug' directory for testing purposes.
    match /debug/{allPaths=**} {
      allow write: if request.auth != null;
      allow read: if request.auth != null;
    }

    // Only admins can write to the config folder, but anyone can read.
    match /config/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.role == 'admin';
    }

    // Only admins can write guidance documents, but any authenticated user can read.
    match /guidance_documents/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'admin';
    }
    
    // Users can only access their own commune's folder.
    match /hoso/{communeId}/{path=**} {
      allow read, write: if request.auth != null && request.auth.token.communeId == communeId;
    }

    // Allow admin to manage announcement files.
    match /hoso/{communeId}/announcements/{allPaths=**} {
        allow read: if request.auth != null; // All users can view announcements
        allow write: if request.auth != null && request.auth.token.role == 'admin';
    }

  }
}
